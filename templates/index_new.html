{% extends "base.html" %}

{% block title %}üéôÔ∏è Voice Translator - Upload Audio{% endblock %}

{% block extra_css %}
<style>
    /* Override base variables for index.html specific styling */
    .container {
        width: 100%;
        max-width: 480px;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        margin: 0 auto;
    }

    header {
        text-align: center;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
    }

    h1 {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
    }

    .subtitle {
        font-size: var(--font-size-base);
        opacity: 0.9;
    }

    .reset-btn {
        position: fixed;
        top: 20%;
        right: 10%;
        background-color: rgb(149 42 42 / 65%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: none;
        z-index: 100;
    }

    .reset-btn.visible {
        display: block;
    }

    .reset-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }

    .language-selector {
        background-color: white;
        color: #1f2937;
        border-radius: var(--border-radius);
        padding: 16px;
        box-shadow: var(--box-shadow);
        width: 100%;
    }

    .language-selector label {
        display: block;
        margin-bottom: 8px;
        color: #6b7280;
        font-weight: 500;
    }

    .language-selector select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        background-color: white;
        color: #1f2937;
        transition: all 0.3s ease;
    }

    .language-selector select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .upload-section {
        background-color: white;
        color: #1f2937;
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        box-shadow: var(--box-shadow);
        text-align: center;
    }

    .upload-section h2 {
        color: #1f2937;
        margin-bottom: var(--spacing-lg);
        font-size: 20px;
        font-weight: 600;
    }

    .upload-zone {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 32px 16px;
        margin-bottom: var(--spacing-lg);
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #fafafa;
    }

    .upload-zone:hover {
        border-color: #2563eb;
        background-color: rgba(37, 99, 235, 0.05);
    }

    .upload-zone.dragover {
        border-color: #2563eb;
        background-color: rgba(37, 99, 235, 0.05);
    }

    .upload-icon {
        font-size: 48px;
        color: #6b7280;
        margin-bottom: 16px;
    }

    .upload-text {
        color: #6b7280;
        font-size: 16px;
        margin-bottom: 8px;
    }

    .upload-subtext {
        color: #6b7280;
        font-size: 14px;
    }

    .file-input {
        display: none;
    }

    .selected-file {
        background-color: #f3f4f6;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: var(--spacing-lg);
        display: none;
    }

    .selected-file.visible {
        display: block;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #1f2937;
    }

    .file-icon {
        color: #059669;
    }

    .upload-btn {
        width: 100%;
        padding: 14px;
        background-color: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: none;
    }

    .upload-btn.visible {
        display: block;
    }

    .upload-btn:hover {
        background-color: #1d4ed8;
    }

    .upload-btn.success {
        background-color: #059669;
    }

    .upload-btn.success:hover {
        background-color: #047857;
    }

    .upload-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }

    .progress-section {
        margin-top: var(--spacing-lg);
        display: none;
    }

    .progress-section.visible {
        display: block;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #f3f4f6;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .progress-fill {
        height: 100%;
        background-color: #2563eb;
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 14px;
        color: #6b7280;
        text-align: center;
    }

    .result-section {
        background-color: white;
        color: #1f2937;
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        box-shadow: var(--box-shadow);
        margin-top: var(--spacing-lg);
        display: none;
    }

    .result-section.visible {
        display: block;
    }

    .result-title {
        color: #1f2937;
        margin-bottom: var(--spacing-lg);
        font-size: 18px;
        font-weight: 600;
    }

    .result-content {
        background-color: #f3f4f6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: var(--spacing-lg);
    }

    .original-text, .translated-text {
        margin-bottom: 16px;
    }

    .original-text h4, .translated-text h4 {
        color: #1f2937;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .original-text p, .translated-text p {
        color: #4b5563;
        line-height: 1.6;
        margin: 0;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        min-width: 120px;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .copy-btn {
        background-color: #2563eb;
        color: white;
    }

    .copy-btn:hover {
        background-color: #1d4ed8;
    }

    .download-btn {
        background-color: #059669;
        color: white;
    }

    .download-btn:hover {
        background-color: #047857;
    }

    .new-file-btn {
        background-color: transparent;
        color: #2563eb;
        border: 2px solid #2563eb;
    }

    .new-file-btn:hover {
        background-color: rgba(37, 99, 235, 0.05);
    }

    .realtime-btn {
        background-color: #f3f4f6;
        color: #1f2937;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-top: var(--spacing-lg);
    }

    .realtime-btn:hover {
        background-color: #e5e7eb;
        color: #1f2937;
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .container {
            max-width: 100%;
            padding: 0;
        }

        .upload-zone {
            padding: 24px 12px;
        }

        .upload-icon {
            font-size: 36px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-btn {
            min-width: auto;
        }

        .reset-btn {
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 6px 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <h1>üéôÔ∏è Voice Translator</h1>
        <p class="subtitle">Upload audio files for instant translation</p>
    </header>

    <button class="reset-btn" id="resetBtn" onclick="resetForm()">
        <i class="fas fa-redo"></i> Reset
    </button>

    <div class="language-selector glass-card">
        <label for="targetLanguage">Translate to:</label>
        <select id="targetLanguage" name="target_language">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ru">Russian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
            <option value="ar">Arabic</option>
            <option value="hi">Hindi</option>
            <option value="nl">Dutch</option>
            <option value="sv">Swedish</option>
            <option value="no">Norwegian</option>
            <option value="da">Danish</option>
            <option value="fi">Finnish</option>
            <option value="pl">Polish</option>
            <option value="tr">Turkish</option>
            <option value="th">Thai</option>
        </select>
    </div>

    <div class="upload-section glass-card">
        <h2>Upload Audio File</h2>
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Click to browse or drag files here</div>
            <div class="upload-subtext">Supports MP3, WAV, M4A, and other audio formats</div>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept="audio/*" onchange="handleFileSelect(event)">
        
        <div class="selected-file" id="selectedFile">
            <div class="file-info">
                <i class="fas fa-file-audio file-icon"></i>
                <span id="fileName"></span>
            </div>
        </div>
        
        <button class="upload-btn" id="uploadBtn" onclick="uploadFile()">
            <i class="fas fa-upload"></i>
            Upload & Translate
        </button>
        
        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
        </div>
    </div>

    <div class="result-section glass-card" id="resultSection">
        <h3 class="result-title">Translation Result</h3>
        <div class="result-content">
            <div class="original-text">
                <h4>Original Text</h4>
                <p id="originalText"></p>
            </div>
            <div class="translated-text">
                <h4>Translated Text</h4>
                <p id="translatedText"></p>
            </div>
        </div>
        <div class="action-buttons">
            <button class="action-btn copy-btn" onclick="copyTranslation()">
                <i class="fas fa-copy"></i>
                Copy
            </button>
            <button class="action-btn download-btn" onclick="downloadTranslation()">
                <i class="fas fa-download"></i>
                Download
            </button>
            <button class="action-btn new-file-btn" onclick="resetForm()">
                <i class="fas fa-plus"></i>
                New File
            </button>
        </div>
    </div>

    <a href="/realtime" class="realtime-btn glass-card">
        <i class="fas fa-microphone"></i>
        Try Real-time Translation
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// Drag and drop functionality
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('audio/')) {
            handleFileSelect({ target: { files: [file] } });
        } else {
            alert('Please select an audio file.');
        }
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('selectedFile').classList.add('visible');
        document.getElementById('uploadBtn').classList.add('visible');
        document.getElementById('resetBtn').classList.add('visible');
    }
}

async function uploadFile() {
    if (!selectedFile) {
        alert('Please select a file first.');
        return;
    }

    const targetLanguage = document.getElementById('targetLanguage').value;
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('target_language', targetLanguage);

    // Show progress
    document.getElementById('progressSection').classList.add('visible');
    document.getElementById('uploadBtn').disabled = true;
    
    let progress = 0;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    // Simulate progress
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        progressFill.style.width = progress + '%';
        progressText.textContent = `Processing... ${Math.round(progress)}%`;
    }, 200);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Complete!';

        if (response.ok) {
            const result = await response.json();
            
            // Show results
            document.getElementById('originalText').textContent = result.original_text;
            document.getElementById('translatedText').textContent = result.translated_text;
            document.getElementById('resultSection').classList.add('visible');
            
            // Update button state
            document.getElementById('uploadBtn').textContent = '‚úì Translation Complete';
            document.getElementById('uploadBtn').classList.add('success');
            
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Upload failed'));
        }
    } catch (error) {
        clearInterval(progressInterval);
        console.error('Upload error:', error);
        alert('Upload failed. Please try again.');
    }
    
    document.getElementById('uploadBtn').disabled = false;
}

function copyTranslation() {
    const translatedText = document.getElementById('translatedText').textContent;
    navigator.clipboard.writeText(translatedText).then(() => {
        // Visual feedback
        const btn = event.target.closest('.copy-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    });
}

function downloadTranslation() {
    const originalText = document.getElementById('originalText').textContent;
    const translatedText = document.getElementById('translatedText').textContent;
    const targetLanguage = document.getElementById('targetLanguage').value;
    
    const content = `Original Text:\n${originalText}\n\nTranslated Text (${targetLanguage}):\n${translatedText}`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `translation_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function resetForm() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('selectedFile').classList.remove('visible');
    document.getElementById('uploadBtn').classList.remove('visible');
    document.getElementById('resetBtn').classList.remove('visible');
    document.getElementById('progressSection').classList.remove('visible');
    document.getElementById('resultSection').classList.remove('visible');
    document.getElementById('uploadBtn').classList.remove('success');
    document.getElementById('uploadBtn').textContent = 'Upload & Translate';
    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> Upload & Translate';
}
</script>
{% endblock %}
